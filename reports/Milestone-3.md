# Milestone 3 - Deployment 


## Pre-requisites on local machine

1. Nodejs 16.14.0 LTS is recommended, note that the latest version 17.x.x will fail on MacOS.
2. VirtualBox should be installed.
3. bakerx should be installed.
4. a **.env** file.

## Overview

#### Provisioning on cloud service   
We implemented the `prod up` command to provision instances for running iTrust on **DigitalOcean** (https://www.digitalocean.com/). It will also generate an **inventory** file which recording droplets' info like this:
```
BLUE_DO_ID=298219130
BLUE_DO_NAME=20220503103704BLUE
BLUE_DO_REGION=nyc1
BLUE_DO_IMAGE=ubuntu-18-04-x64
BLUE_DO_IP=159.223.184.79
GREEN_DO_ID=298219171
GREEN_DO_NAME=20220503103704GREEN
GREEN_DO_REGION=nyc1
GREEN_DO_IMAGE=ubuntu-18-04-x64
GREEN_DO_IP=159.223.189.166
```

#### iTrust deployment job spec  
We extended the build job from M1 to create a war file for deployment. Then we used the last built iTrust and deployed it to the production environment provided in the inventory mentioned above. Since the original iTrust code can't create a war file worked on Tomcat, we use a forked repo and patch the code instead.


#### Implement a deployment strategy
We implemented the blue/green deployment strategy by creating two separate, but identical cloud environments. The BLUEüîµ environment is for running the current application version of iTrust and the GREENüü¢  environment is for running the new application version of iTrust.  

## Features
Besides required commands, there are other commands that can make setup easier:

`node index.js prod del <droplet_id>`: delete a droplet by id

`node index.js prod ld`: list all droplets on your DigitalOcean account

`node index.js prod lr`: list DigitalOcean server regions

`node index.js prod limg`: list DigitalOcean images

`node index.js prod ip <droplet_id>`: print the ip address of a droplet by id

`node index.js prod lssh`: list all SSH keys on your DigitalOcean account

`node index.js prod blue`: SSH connect to the blue environment

`node index.js prod green`: SSH connect to the green environment

## Use

#### 1Ô∏è‚É£. `cd` into project directory `/DEVOPS-33`
```
npm install
npm link
```
#### 2Ô∏è‚É£. Create your own `.env` file under `/DEVOPS-33` using below template:
```
NCSU_GIT_USER=your_github.ncsu.edu_user_name
NCSU_GIT_TOKEN=your_github.ncsu.edu_token__not_password__
PRIV_GIT_USER=your_github.com_user_name
PRIV_GIT_TOKEN=your_github.com_token__not_password__
SSH_PRIVATE_KEY=~/.bakerx/insecure_private_key
SSH_PORT=2002
DO_TOKEN=your_digital_ocean_api_token
DO_REGION=nyc1
DO_IMAGE=ubuntu-18-04-x64
DO_PRIVATE_KEY=~/.ssh/id_rsa
DO_PUB_ID=34379664
DO_PUB_FINGERPRINT=70:8b:2d:7a:bb:c0:32:44:b5:03:35:a0:20:db:53:df
```
Field specification:

SSH_PRIVATE_KEY: Your **bakerx** private ssh key path.

DO_TOKEN: You can generate the token at https://cloud.digitalocean.com/account/api/tokens after registering a DigitalOcean account.

DO_REGION: You can use `node index.js prod lr` to list DigitalOcean server regions and select one.

DO_IMAGE: You can use `node index.js prod limg` to list DigitalOcean images and select one.

DO_PRIVATE_KEY: Your **PC** private ssh key path, can be generated by `ssh-keygen`

DO_PUB_ID and DO_PUB_FINGERPRINT: Steps to set these two fields are a bit complicate:

1. Add your public SSH key (generated by `ssh-keygen` command) into your DigitalOcean account at https://cloud.digitalocean.com/account/security

2. Use `node index.js prod lssh` to list SSH keys on your DigitalOcean account. An example output:
```sh
{
  ssh_keys: [
    {
      id: 34379664,
      public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC4b/otm0Tod3t072MKRnEtuzRyxfRyoB3DTVzJhqaV7MYmBhiQEbSUv/EzzKzWEoEr6+BzGzbC7whSgBRVoboV1xEQ9hXoznj6jsXdCVCsnnsisg9lm2/imd82Fe/DOhq4LjvRuhKh68ZPmpm9JwyZT+Hl/V6/jEVJBUUdr3m+baQc8x/9nioeAQ3F3pT2sawAbf0Ts0M8WhKPujHY1B1vd9g26QooA+9gbpQkAF/mwTFA6GDhmMW+2alyWGDSkAoqb0Loi2z23pse0rxzO/5hgHh+od7a2bXqWUnwXTy7YkjS8B0D4fU5t9doEJilQZNVJwJzBhA85lLziR0SdT5kHamZUl1AaHesvA74qiZSZ7SqYJ+pk++uSpMFtp5Y52O6tH7XC2j0kN0CpYMuFRM3dCvkeTJgJecI7RfJPgw0EnCzVkXRRl9CzLO6a7HyCNPhvb5SuIbwD5ImAEPKoXqh2+CosBGYJDrqu98dzKeW/8krgDJ8aUob7xxYxmcT95s= vi@Nokia9580',
      name: 'nokia',
      fingerprint: '70:8b:2d:7a:bb:c0:32:44:b5:03:35:a0:20:db:53:df'
    }
  ],
  links: { pages: {} },
  meta: { total: 1 }
}
```
Then set `id` and `fingerprint` values to **DO_PUB_ID** and **DO_PUB_FINGERPRINT** without single quotation marks. i.e., fingerprint, not 'fingerprint'

Offical Guide: https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-account/

#### 3Ô∏è‚É£. Provision and configure computing environment for pipeline:
```
node index.js init
```
#### 4Ô∏è‚É£. Automatically configure a build environment for iTrust2-v10
```
node index.js build itrust-build build.yml
```
#### 5Ô∏è‚É£. Trigger the mutation coverage build job (M2)
```
node index.js build mutation-coverage build.yml
```

#### 6Ô∏è‚É£. Provisioning cloud instance
```
node index.js prod up
```

#### 7Ô∏è‚É£. Trigger the deployment for iTrust
```
node index.js deploy inventory itrust-deploy build.yml
```

#### 8. Monitor Traffic change
```
node index.js serve
```

## Challenges
### Tomcat
Setting up Tomcat is the most troublesome part of this milestone. 

To solve the problem that iTrust can't run on Tomcat, I have to fork the iTrust repo and modify some code to generate a valid war package, including: 

1. modify `pom.xml`
```xml
...
<packaging>war</packaging>
...
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-tomcat</artifactId>
    <scope>provided</scope>
</dependency>
...
```
2. modify iTrust main class to use SpringBootServletInitializer features: 
```java
//...
import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;
//...
public class ITrust2Application extends SpringBootServletInitializer {
//...
}
```

Thanks for the guide: https://www.baeldung.com/spring-boot-war-tomcat-deploy

### DigitalOcean SSH key
DigitalOcean droplet can't be connected via ssh in a simple way like what we implemented on vms in M2. It took me a long time to read DigitalOcean API documentation.

### Operation interval problem
Some operations like `scp` has a short delay on effect. For example, when using scp command to copy shell scripts to DigitalOcean droplet and execute it immediately, there might be an error that file is not found. So I add a delay snippet to solve this problem.
```js
await new Promise(resolve => setTimeout(resolve, 1500));
```

### Trigger traffic change
Since it's hard to change war package deployment by git commit, I choose to simulate 'bad commit' via Tomcat gui webpage. I grant the gui permisson by adding steps in `build.yml` 

## Screencast link

https://youtu.be/DUjy3Xkfy7c









